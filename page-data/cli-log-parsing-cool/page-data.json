{"componentChunkName":"component---src-templates-blog-post-js","path":"/cli-log-parsing-cool/","result":{"data":{"site":{"siteMetadata":{"title":"p3t.lu"}},"markdownRemark":{"id":"2215beab-6bcb-54c8-af85-fb5b092f37db","excerpt":"最近有種感覺，因為雲端服務的蓬勃發展，在 Unix-Like 中荒野求生的需求越來越少，解析 log…","html":"<p>最近有種感覺，因為雲端服務的蓬勃發展，在 Unix-Like 中荒野求生的需求越來越少，解析 log 檔好像已經漸漸的沒那麼被重視？需要？還是這其實是我的錯覺… 或是換句話說，這個技能正在失傳。</p>\n<!--more-->\n<p>是不是錯覺不知道，也可能是我職涯發展的關係，越來越少遇到擁有這項技能的人，在我大三修的系統管理課堂中，老師帶我們看了一些終端機指令的原始碼後，講了句讓我到現在都還印象深刻的話：「這些程式都是經過長時間的驗證流傳到現在，不要重複造輪子，自己寫也未必會寫的比它好。」</p>\n<p>無論如何來分享一下我面對一個 Log 檔的思路吧。</p>\n<hr>\n<h2>本篇有用到的指令</h2>\n<p>file、ls、cat、head、grep、awk、sort、uniq</p>\n<hr>\n<h2>情境開始</h2>\n<p>假設今天遇到了一個 log 檔</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ file access.log\naccess.log: ASCII text, with very long lines</code></pre></div>\n<p>確定是文字檔</p>\n<h2>檔案大小</h2>\n<p>首先來確認一下檔案大小</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ls -lh access.log\n-rw-r----- 1 dsewnr dsewnr 249K  9月 28 10:10 access.log</code></pre></div>\n<p>OK，檔案沒很大</p>\n<p>直接印出內容看，或用編輯器直接打開來看</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cat access.log\n... (略)\n85.105.133.146 - - [27/Sep/2019:06:34:42 +0800] \"GET / HTTP/1.0\" 200 415 \"-\" \"-\"\n216.244.66.240 - - [27/Sep/2019:06:35:54 +0800] \"GET /robots.txt HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)\"\n66.249.79.227 - - [27/Sep/2019:06:37:33 +0800] \"GET /ads.txt HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\"\n14.186.29.249 - - [27/Sep/2019:06:38:12 +0800] \"GET ../../mnt/custom/ProductDefinition HTTP\" 400 173 \"-\" \"-\"\n216.244.66.242 - - [27/Sep/2019:06:41:34 +0800] \"GET /robots.txt HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)\"\n18.233.194.247 - - [27/Sep/2019:06:44:54 +0800] \"GET /robots.txt HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; AdsrvrBot)\"\n216.244.66.226 - - [27/Sep/2019:06:46:50 +0800] \"GET /robots.txt HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)\"\n148.64.56.126 - - [27/Sep/2019:06:49:09 +0800] \"GET /tidal/%E6%BC%81%E6%B8%AF%E8%8A%B1%E8%93%AE HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; GrapeshotCrawler/2.0; +http://www.grapeshot.co.uk/crawler.php)\"\n66.249.79.229 - - [27/Sep/2019:06:51:16 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\"\n54.36.149.83 - - [27/Sep/2019:07:01:57 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; AhrefsBot/6.1; +http://ahrefs.com/robot/)\"</code></pre></div>\n<p>那假設今天的<strong>檔案很大</strong>，是幾 G 幾十 G 甚至是破百 G 呢？</p>\n<p>cat 下去螢幕刷到天荒地老，編輯器一開當在那邊，會是什麼問題？</p>\n<p>硬碟 I/O 不夠快，記憶體不夠大，是我的問題嗎(x)</p>\n<h2>特徵</h2>\n<p>Log 檔很大！問題就很大！</p>\n<p>那就要來想辦法折解問題，把問題變小，把 log 檔變小。</p>\n<p>假設有明確的特徵，先用 grep 把有特徵的 log 重導向到新的檔案</p>\n<p>例如特徵是某個 IP 好了</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ grep 210.52.224.155 access.log > access.log.210.52.224.155\n$ cat access.log.210.52.224.155\n...(略)\n210.52.224.155 - - [28/Sep/2019:01:14:37 +0800] \"GET / HTTP/1.0\" 200 415 \"-\" \"-\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /nmaplowercheck1569604487 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET / HTTP/1.0\" 200 415 \"-\" \"-\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET / HTTP/1.0\" 200 415 \"-\" \"-\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"POST /sdk HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET / HTTP/1.1\" 200 415 \"-\" \"-\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /evox/about HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /HNAP1 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:15:02 +0800] \"GET / HTTP/1.1\" 200 415 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:03 +0800] \"GET / HTTP/1.1\" 200 415 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:16 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:17 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:28 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:29 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:44 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:45 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:46 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:48 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:49 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:50 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"</code></pre></div>\n<p>把有包含該 IP 的 log 找出來了</p>\n<p>更進一步只想知道狀態碼不是 200 的 log</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{if($9!=200){print $0}}' access.log.210.52.224.155 > access.log.210.52.224.155-200\n$ cat access.log.210.52.224.155-200\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /nmaplowercheck1569604487 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"POST /sdk HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /evox/about HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /HNAP1 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:15:16 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:17 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:28 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:29 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:44 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:45 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:46 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:48 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"\n210.52.224.155 - - [28/Sep/2019:01:15:49 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; Wappalyzer)\"\n210.52.224.155 - - [28/Sep/2019:01:15:50 +0800] \"GET / HTTP/1.1\" 301 185 \"-\" \"Chrome/54.0 (Windows NT 10.0)\"</code></pre></div>\n<p>把有包含該 IP 並且狀態碼不是 200 的 log 找出來了</p>\n<p>或是再更進一步只想知道狀態碼不是 200 並且時間是在一點十四分的 log</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{if($9!=200){print $0}}' access.log.210.52.224.155-200 | grep 28\\/Sep\\/2019:01:14 > access.log.210.52.224.155-200-201909280114\n$ cat access.log.210.52.224.155-200-201909280114\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /nmaplowercheck1569604487 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"POST /sdk HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /evox/about HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"\n210.52.224.155 - - [28/Sep/2019:01:14:47 +0800] \"GET /HNAP1 HTTP/1.1\" 404 169 \"-\" \"Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)\"</code></pre></div>\n<p>把有包含該 IP 並且狀態碼不是 200 且時間是在一點十四分的 log 找出來了</p>\n<p>就是這樣一層一層過濾讓 log 檔越變越小直到找到目標。</p>\n<h2>分析</h2>\n<p>假設今天想知道哪個 IP 造訪次數最多</p>\n<p>先用 head 指令大概瞄一下 log 檔的長像</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ head -n 100 access.log\n...(略)\n66.240.205.34 - - [27/Sep/2019:08:38:53 +0800] \"Gh0st\\xAD\\x00\\x00\\x00\\xE0\\x00\\x00\\x00x\\x9CKS``\\x98\\xC3\\xC0\\xC0\\xC0\\x06\\xC4\\x8C@\\xBCQ\\x96\\x81\\x81\\x09H\\x07\\xA7\\x16\\x95e&amp;\\xA7*\\x04$&amp;g+\\x182\\x94\\xF6\\xB000\\xAC\\xA8rc\\x00\\x01\\x11\\xA0\\x82\\x1F\\x5C`&amp;\\x83\\xC7K7\\x86\\x19\\xE5n\\x0C9\\x95n\\x0C;\\x84\\x0F3\\xAC\\xE8sch\\xA8^\\xCF4'J\\x97\\xA9\\x82\\xE30\\xC3\\x91h]&amp;\\x90\\xF8\\xCE\\x97S\\xCBA4L?2=\\xE1\\xC4\\x92\\x86\\x0B@\\xF5`\\x0CT\\x1F\\xAE\\xAF]\" 400 173 \"-\" \"-\"\n66.249.79.48 - - [27/Sep/2019:08:40:59 +0800] \"GET /tidal/%E6%96%B0%E7%AB%B9%E5%B8%82%E9%A6%99%E5%B1%B1%E5%8D%80?PageSpeed=noscript HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\"\n154.126.215.85 - - [27/Sep/2019:08:41:33 +0800] \"GET / HTTP/1.1\" 200 415 \"-\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\"\n157.55.39.31 - - [27/Sep/2019:08:43:02 +0800] \"GET /robots.txt HTTP/1.1\" 301 185 \"-\" \"Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)\"</code></pre></div>\n<p>看起來是空白分隔的，有 IP、時間、請求方法、路徑、通訊協定…等</p>\n<p>把 IP 截取出來</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{print $1}' access.log\n...(略)\n202.39.54.2\n63.143.42.249\n63.143.42.249\n216.244.66.240\n216.244.66.240\n157.55.39.89\n63.143.42.249\n63.143.42.249\n63.143.42.249\n63.143.42.249\n148.64.56.116\n216.244.66.242\n63.143.42.249\n63.143.42.249\n216.244.66.240\n207.46.13.209\n63.143.42.249\n63.143.42.249</code></pre></div>\n<p>把 IP 截取出來，並排序</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{print $1}' access.log | sort\n...(略)\n79.35.38.172\n81.201.62.105\n83.110.151.181\n83.219.146.185\n84.19.90.115\n85.105.133.146\n86.122.156.239\n89.64.61.182\n89.64.61.182\n91.134.248.253\n91.148.141.162\n91.206.33.25\n91.217.254.53\n94.46.176.10\n94.46.176.10\n94.46.176.10\n94.46.176.10\n95.161.230.138</code></pre></div>\n<p>把 IP 截取出來，並排序，然後算出現的次數</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{print $1}' access.log | sort | uniq -c\n...(略)\n      2 66.249.79.96\n      1 72.139.68.174\n      1 77.89.245.118\n      1 78.128.113.18\n      2 79.239.51.30\n      1 79.35.38.172\n      1 81.201.62.105\n      1 83.110.151.181\n      1 83.219.146.185\n      1 84.19.90.115\n      1 85.105.133.146\n      1 86.122.156.239\n      2 89.64.61.182\n      1 91.134.248.253\n      1 91.148.141.162\n      1 91.206.33.25\n      1 91.217.254.53\n      4 94.46.176.10\n      1 95.161.230.138</code></pre></div>\n<p>把 IP 截取出來，並排序，然後算出現的次數</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ awk '{print $1}' access.log | sort | uniq -c | sort -n -k 1\n...(略)\n      4 52.11.94.217\n      4 94.46.176.10\n      5 148.64.56.113\n      5 148.64.56.123\n      5 192.99.15.139\n      7 216.244.66.239\n      7 64.140.200.40\n      9 112.29.140.226\n     10 66.249.79.51\n     13 216.244.66.242\n     14 144.76.4.41\n     20 210.52.224.155\n     33 192.99.14.117\n     33 192.99.6.138\n     35 216.244.66.226\n     37 66.249.79.48\n     50 192.151.145.82\n     54 144.76.60.198\n     54 158.69.245.202\n     72 216.244.66.240\n    549 63.143.42.249</code></pre></div>\n<p>這樣就可以知道每個 IP 造訪幾次了！</p>\n<hr>\n<p>以上是目前想到最基本的應用，還有很多很多好用的指令還沒提到，各種指令組合變化又可以解決更多不同的問題。</p>\n<p>有想到再寫 :P</p>","frontmatter":{"title":"面對 Log 檔的思路","date":"September 28, 2019","description":null}},"previous":{"fields":{"slug":"/pycon-taiwan-2019/"},"frontmatter":{"title":"PyCon Taiwan 2019"}},"next":{"fields":{"slug":"/e-ink-kobo-libra-h2o/"},"frontmatter":{"title":"E Ink: Kobo Libra H2O 開箱"}}},"pageContext":{"id":"2215beab-6bcb-54c8-af85-fb5b092f37db","previousPostId":"6ea9a5e3-8151-5272-aa5c-2102e477f663","nextPostId":"28a8c66c-6b99-57c3-9af7-d3645fdce2e8"}},"staticQueryHashes":["3624854548","548598555"]}